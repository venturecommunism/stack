define(function(e,t,n){"use strict";function v(e,t){navigator.notification?navigator.notification.alert(e,null,t):alert(e)}function w(e,t,n,r){if(n=n||"",navigator.notification)navigator.notification.prompt(e,function(e){t(1===e.buttonIndex?e.input1:null)},n,["Ok","Cancel"],r);else{var i=prompt(e,r,n);t(i)}}function x(e,t,n,r,i){if(n=n||"",navigator.notification)navigator.notification.confirm(e,function(e){t(1===e)},n,[r,i]);else{var a=confirm(e);t(a)}}function b(e){var r=document.createElement("a");r.setAttribute("href","bingo.html"),r.click()}function S(){var e=r.range(1,10).map(function(e){var t="box"+e+"image",n="box"+e+"name";return{name:i.get(n),image:i.get(t)}});return e}function k(){return S().filter(function(e){return e.image})}function M(e,t){var n=new Image;n.onload=function(){var s=((u-n.width)/2,(o-n.height)/2,n.height*(u/n.width));r.select("#"+e).style("background-image","url("+t+")").style("background-size",u+"px "+s+"px")},n.src=t}function E(e,t){function i(e){return new Promise(function(r,i){e.classed(t,!0),setTimeout(function(){r(!0)},n)})}var a,n=350;return r.selectAll(e).each(function(){var e=r.select(this);a=a?a.then(function(){return i(e)}):i(e)}),a}function C(e,t){var n=(document.documentElement.clientHeight-3*u)/2,i=r.select("#alertContainer");i.style("display","block").style("top","-"+3*u+"px").on("click",null);r.select("#alertContainer img").attr("src",e).style("width",3*u+"px");i.on("click",function(){i.transition().duration(500).style("top","-1300px").each("end",function(){if(i.style("display","none"),r.select(".tile").classed("flip")){var e=E(".tile","unflip");e.then(function(){r.selectAll(".tile").classed("flip",!1)})}})}),i.transition().duration(2e3).style("top",n+"px").ease("bounce").each("end",function(){"function"==typeof t&&t()})}function T(){r.selectAll(".tile").classed("unflip",!1);var e=E(".tile","flip");e.then(function(){C("img/bingo.png")})}function A(e){var t=+e.substr(3),n=p[t].split("").some(function(e){return!i.get("box"+e+"image")});return!n}function _(e){var t=+e.substr(3),n=[1,3,7,9],r=n.indexOf(t)>=0&&n.every(function(e){return i.get("box"+e+"image")});return r}function D(e,t,n){function s(){setTimeout(function(){r.selectAll("#alertContainer").style("display","none")},750)}var o,u,a=+t.substr(3);M(t,e),i.set(t+"image",e),9===k().length?T():_(t)?(o=["#box1","#box3","#box7","#box9"],u=o.join(","),r.selectAll(u).classed("unflip",!1),E(u,"flip").then(function(){E(o.reverse().join(","),"unflip").then(function(){r.selectAll(u).classed("flip",!1)}),C("img/corners.png",s)})):A(t)&&(o=p[a].split("").map(function(e){return"#box"+e}),u=o.join(","),r.selectAll(u).classed("unflip",!1),E(u,"flip").then(function(){E(o.reverse().join(","),"unflip").then(function(){r.selectAll(u).classed("flip",!1)}),C("img/line.png",s)}))}function F(e){if(1==e.target.files.length&&0==e.target.files[0].type.indexOf("image/")){var t=e.target.files[0];EXIF.getData(t,function(){var e=EXIF.getTag(this,"Orientation"),n=new MegaPixImage(t),r=document.createElement("canvas");n.onrender=function(t){D(t.toDataURL(),a,e),a=""},n.render(r,{maxWidth:s,maxHeight:h,orientation:e})})}}function L(e){var t=r.select("#"+e+" .name"),n=t.html(),a="Enter the name of the person you want to meet: ",o="Name a face";w(a,function(n){null!==n&&(t.style("background","rgba(0,0,0,0.4)").html(n),i.set(e+"name",n))},o,n)}function O(){var n=document.documentElement.clientWidth,r=document.documentElement.clientHeight;window.screen.width,window.screen.height;c=n,f=r-l,u=c/3,o=f/3,$("body").css({width:c+"px",height:f+"px"}),$(".tile, .back").css({width:u+"px",height:o+"px"})}function q(){$(".tile").on("click",function(e){if(e.target===this){var t=$("#"+this.id+" .name"),n=t.html();0===n.trim().length?L(this.id):(a=this.id,$("#photo-capture").click())}}),$("#photo-capture").on("change",F),$(".name").on("click",function(e){e.stopPropagation(),L(this.parentNode.id)}),$("#share").on("click",function(e){var t=k();9===t.length?b():x("You haven't got a full house yet – share anyway?",function(e){e&&b()},"Share your image","Share anyway","Ok, I'll wait")}),$("#about").on("click",function(e){e.stopPropagation(),v(g,"About")})}function j(e,t){r.select("#"+e+" .name").html(t).style("background","rgba(0,0,0,0.4)")}function R(){r.selectAll(".tile").each(function(){var e=this.id,t=i.get(e+"name"),n=i.get(e+"image");t&&j(e,t),n&&M(e,n)})}var o,u,c,f,r=require("lib/d3.min"),i=require("Storage.min"),a="",s=600,l=40,h=250,g="CHI Bingo is a fun app that aims to increase social activity at CHI.\n\nThe aim is simple — before (or during) the conference, enter nine names of people you'd like to talk to. When you arrive, the race is on to get 'selfie' photos with each of them before the conference ends. Easy!\n\nOnce your grid is complete, you can share it with others.\n\n\nCHI Bingo was inspired by the late Gary Marsden — a CHI veteran and dear friend.",p={1:"123",2:"123",3:"123",4:"456",5:"456",6:"456",7:"789",8:"789",9:"789"},H={initialize:function(){this.bindEvents()},bindEvents:function(){$(document).ready(function(){R(),q(),O(),FastClick.attach(document.body)})},onDeviceReady:function(){},receivedEvent:function(e){}};n.exports=H});